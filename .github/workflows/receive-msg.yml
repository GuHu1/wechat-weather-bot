name: 接收微信消息
on:
  workflow_dispatch:
    inputs:
      message_json:
        description: '消息JSON数据'
        required: true

permissions: write-all

jobs:
  save-message:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 安装 jq 工具
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: 解析并保存消息
        run: |
          # 解析JSON
          MESSAGE='${{ github.event.inputs.message_json }}'
          
          # 提取字段
          TIMESTAMP=$(echo $MESSAGE | jq -r '.timestamp')
          OPENID=$(echo $MESSAGE | jq -r '.openid')
          TYPE=$(echo $MESSAGE | jq -r '.type')
          CONTENT=$(echo $MESSAGE | jq -r '.content')
          MEDIAID=$(echo $MESSAGE | jq -r '.mediaId')
          
          # OpenID 到昵称的映射
          declare -A USER_MAP=(
            ["oHyqu2MKpIzBHn1pOxiuvzJmi0ek"]="GuHui"
            ["oHyqu2EJPTCZIFHyooewIfjnp5Jw"]="nNiii"
          )
          NICKNAME="${USER_MAP[$OPENID]:-$OPENID}"
          
          # 转换为北京时间
          BEIJING_TIME=$(date -d "@$TIMESTAMP" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || date '+%Y-%m-%d %H:%M:%S')
          
          # 创建日期文件夹
          DATE_FOLDER=$(date -d "@$TIMESTAMP" '+%Y-%m-%d' 2>/dev/null || date '+%Y-%m-%d')
          mkdir -p "messages/$DATE_FOLDER"
          
          # 保存可读日志（使用昵称）
          echo "[$BEIJING_TIME] [$TYPE] $NICKNAME: $CONTENT" >> "messages/$DATE_FOLDER/messages.txt"
          
          # 如果是媒体消息，添加下载链接（修复空格问题）
          if [ "$MEDIAID" != "null" ] && [ -n "$MEDIAID" ]; then
            # 使用你的真实Render域名，移除所有空格
            DOWNLOAD_URL="https://wechat-weather-bot.onrender.com/download/${MEDIAID}"
            echo "[$BEIJING_TIME] [$TYPE] $NICKNAME: [下载链接] $DOWNLOAD_URL" >> "messages/$DATE_FOLDER/media.txt"
            echo "生成的下载链接: $DOWNLOAD_URL"  # 调试用
          fi
          
          # 保存完整JSON
          echo $MESSAGE >> "messages/$DATE_FOLDER/data.json"
          
          # 提交到仓库
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add messages/
          git commit -m "添加新消息 (用户: $NICKNAME, 类型: $TYPE)" || echo "无新内容"
          git push
